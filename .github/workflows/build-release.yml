name: Build and Release APK

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      flavor:
        description: 'Build flavor'
        required: true
        default: 'beta'
        type: choice
        options:
          - stable
          - beta
          - nightly
          - all

env:
  JAVA_VERSION: '21'

jobs:
  build:
    name: Build ${{ matrix.flavor }} APK
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        flavor: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.flavor == 'all' && fromJson('["stable", "beta", "nightly"]') || fromJson(format('["{0}"]', github.event.inputs.flavor))) || fromJson('["stable", "beta", "nightly"]') }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'beta'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Create .env file
        run: |
          cat > .env << EOF
          API_BASE_URL=${{ secrets.API_BASE_URL }}
          CDN_BASE_URL=${{ secrets.CDN_BASE_URL }}
          UPDATE_API_URL=${{ secrets.UPDATE_API_URL }}
          ARTIST_PROFILE_API_URL=${{ secrets.ARTIST_PROFILE_API_URL }}
          LASTFM_API_KEY=${{ secrets.LASTFM_API_KEY }}
          LASTFM_SHARED_SECRET=${{ secrets.LASTFM_SHARED_SECRET }}
          FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_APP_ID_ANDROID=${{ secrets.FIREBASE_APP_ID_ANDROID }}
          FIREBASE_APP_ID_WEB=${{ secrets.FIREBASE_APP_ID_WEB }}
          FIREBASE_API_KEY_ANDROID=${{ secrets.FIREBASE_API_KEY_ANDROID }}
          FIREBASE_API_KEY_WEB=${{ secrets.FIREBASE_API_KEY_WEB }}
          FIREBASE_MESSAGING_SENDER_ID=${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          FIREBASE_MESSAGING_SENDER_ID_WEB=${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          FIREBASE_AUTH_DOMAIN=${{ secrets.FIREBASE_AUTH_DOMAIN }}
          FIREBASE_STORAGE_BUCKET=${{ secrets.FIREBASE_STORAGE_BUCKET }}
          ENABLE_CLOUD_FEATURES=true
          ENABLE_SAS=true
          DEBUG_MODE=false
          EOF

      - name: Setup google-services.json
        run: |
          if [ "${{ matrix.flavor }}" = "stable" ]; then
            echo "${{ secrets.GOOGLE_SERVICES_JSON_STABLE }}" | base64 -d > android/app/src/main/google-services.json
          elif [ "${{ matrix.flavor }}" = "beta" ]; then
            echo "${{ secrets.GOOGLE_SERVICES_JSON_BETA }}" | base64 -d > android/app/src/beta/google-services.json
          elif [ "${{ matrix.flavor }}" = "nightly" ]; then
            echo "${{ secrets.GOOGLE_SERVICES_JSON_NIGHTLY }}" | base64 -d > android/app/src/nightly/google-services.json
          fi

      - name: Extract version from pubspec
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | cut -d'+' -f1)
          VERSION_CODE=$(grep '^version:' pubspec.yaml | sed 's/.*+//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "Version: $VERSION, Code: $VERSION_CODE"

      - name: Setup signing
        if: env.KEYSTORE_BASE64 != ''
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/app/keystore.jks
          cat > android/key.properties << EOF
          storeFile=keystore.jks
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          EOF

      - name: Build APK
        run: |
          flutter build apk --flavor ${{ matrix.flavor }} --release

      - name: Rename APK
        run: |
          mv build/app/outputs/flutter-apk/app-${{ matrix.flavor }}-release.apk \
             build/app/outputs/flutter-apk/sono-${{ matrix.flavor }}-v${{ steps.version.outputs.version }}.apk

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: sono-${{ matrix.flavor }}-v${{ steps.version.outputs.version }}
          path: build/app/outputs/flutter-apk/sono-${{ matrix.flavor }}-v${{ steps.version.outputs.version }}.apk

      - name: Upload to Version Service
        if: env.VERSION_API_URL != '' && env.VERSION_WEBHOOK_SECRET != ''
        env:
          VERSION_API_URL: ${{ secrets.VERSION_API_URL }}
          VERSION_WEBHOOK_SECRET: ${{ secrets.VERSION_WEBHOOK_SECRET }}
        run: |
          APK_PATH="build/app/outputs/flutter-apk/sono-${{ matrix.flavor }}-v${{ steps.version.outputs.version }}.apk"

          echo "Encoding APK to base64..."
          APK_BASE64=$(base64 -w 0 "$APK_PATH")

          COMMIT_MSG=$(git log -1 --pretty=%B | head -1 | tr -d '"' | tr -d "'" | cut -c1-200)

          COMMIT_MSG=$(echo "$COMMIT_MSG" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | tr '\n' ' ')
          
          cat > upload_payload.json <<EOF
          {
            "channel": "${{ matrix.flavor }}",
            "version": "${{ steps.version.outputs.version }}",
            "version_code": ${{ steps.version.outputs.version_code }},
            "release_notes": "$COMMIT_MSG",
            "apk_base64": "$APK_BASE64"
          }
          EOF
          
          echo "Uploading to version service..."
          RESPONSE=$(curl -X POST "${{ secrets.VERSION_API_URL }}/api/v1/upload" \
            -H "Content-Type: application/json" \
            -H "X-Webhook-Secret: ${{ secrets.VERSION_WEBHOOK_SECRET }}" \
            --data-binary @upload_payload.json \
            -w "\nHTTP_CODE:%{http_code}" \
            -s)
          
          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')
          
          echo "Response: $BODY"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "Successfully uploaded ${{ matrix.flavor }} v${{ steps.version.outputs.version }}"
          else
            echo "Upload failed with status $HTTP_CODE"
            echo "Response body: $BODY"
          fi
          
          rm -f upload_payload.json

    outputs:
      version: ${{ steps.version.outputs.version }}
      version_code: ${{ steps.version.outputs.version_code }}

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f -name "*.apk"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/**/*.apk
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'nightly') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}