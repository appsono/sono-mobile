name: Build iOS IPA

on:
  workflow_dispatch:

jobs:
  build-ios:
    name: Build iOS IPA (unsigned)
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'beta'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Create .env file
        run: |
          cat > .env << EOF
          API_BASE_URL=${{ secrets.API_BASE_URL }}
          CDN_BASE_URL=${{ secrets.CDN_BASE_URL }}
          UPDATE_API_URL=${{ secrets.UPDATE_API_URL }}
          ARTIST_PROFILE_API_URL=${{ secrets.ARTIST_PROFILE_API_URL }}
          LASTFM_API_KEY=${{ secrets.LASTFM_API_KEY }}
          LASTFM_SHARED_SECRET=${{ secrets.LASTFM_SHARED_SECRET }}
          FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_APP_ID_ANDROID=${{ secrets.FIREBASE_APP_ID_ANDROID }}
          FIREBASE_APP_ID_WEB=${{ secrets.FIREBASE_APP_ID_WEB }}
          FIREBASE_API_KEY_ANDROID=${{ secrets.FIREBASE_API_KEY_ANDROID }}
          FIREBASE_API_KEY_WEB=${{ secrets.FIREBASE_API_KEY_WEB }}
          FIREBASE_MESSAGING_SENDER_ID=${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          FIREBASE_MESSAGING_SENDER_ID_WEB=${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          FIREBASE_AUTH_DOMAIN=${{ secrets.FIREBASE_AUTH_DOMAIN }}
          FIREBASE_STORAGE_BUCKET=${{ secrets.FIREBASE_STORAGE_BUCKET }}
          ENABLE_CLOUD_FEATURES=true
          ENABLE_SAS=true
          DEBUG_MODE=false
          EOF

      - name: Extract version from pubspec
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | cut -d'+' -f1)
          VERSION_CODE=$(grep '^version:' pubspec.yaml | sed 's/.*+//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "Version: $VERSION, Code: $VERSION_CODE"

      - name: Install CocoaPods (pre-build)
        run: |
          cd ios
          pod install

      - name: Build iOS (unsigned)
        run: flutter build ios --profile --no-codesign

      - name: Verify Frameworks in Runner.app
        run: |
          APP_PATH="build/ios/iphoneos/Runner.app"
          echo "Checking frameworks in Runner.app..."
          if [ -d "$APP_PATH/Frameworks" ]; then
            echo "✓ Frameworks directory exists"
            ls -la "$APP_PATH/Frameworks/"
          else
            echo "✗ Frameworks directory missing! Plugins won't work."
            exit 1
          fi

          echo "Checking for just_audio framework..."
          if [ -d "$APP_PATH/Frameworks/just_audio.framework" ] || [ -f "$APP_PATH/Frameworks/just_audio.framework" ]; then
            echo "✓ just_audio framework found"
          else
            echo "✗ just_audio framework NOT found!"
            echo "Available frameworks:"
            ls -la "$APP_PATH/Frameworks/" || echo "No frameworks at all!"
          fi

      - name: Package unsigned IPA
        run: |
          APP_PATH="build/ios/iphoneos/Runner.app"
          mkdir -p Payload
          cp -r "$APP_PATH" Payload/
          zip -r "sono-ios-v${{ steps.version.outputs.version }}-unsigned.ipa" Payload
          rm -rf Payload

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: sono-ios-v${{ steps.version.outputs.version }}-unsigned
          path: sono-ios-v${{ steps.version.outputs.version }}-unsigned.ipa
